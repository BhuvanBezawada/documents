Motivation
==========

Nexus files have three pieces of information in which we can use to determine which IDF to load.
The current structure is poorly understood, and on investigation is a mess.
 
At the moment, for determining the mangled filename (how we decide if the file is already loaded in the IDS):

  1. if the filename is present use the file contents if it is available
  1. use the xml string for loading the file from nexus

and for loading the file

  1. if instrument name is not set, undefined behaviour
  1. if instrument_xml is present then load that xml (instrument filename is set to the value in the NXS file, not the nxs file itself)
  1. if filename has been entered them make up a filename out of the directory and instrument name and output an incorrect log message.
    Load the most fitting file based on the instrument name

At no point would the filename specified be loaded even if correct and present

 
Proposed Solution
=================

For file name mangling:

  1.  use the xml string for loading the file from nexus
  1.  if the filename is present use the file contents if it is available

for loading the file:

  1. if instrument_xml is present then load that xml (instrument filename is set to the nxs file itself)
  1. if filename has been entered them Load the file from that location is it is present.
      1. on the same path
      1. in any of the instrument directories (in the correct order)
  1. for both of the above if the instrument name is not set then read it from the inst defnintion.
  1. Load the most fitting file based on the instrument name

 
 
This primarily involves changes to:

  * ExperimentInfo::loadInstrumentInfoNexus - for the loading order of the IDF itself
  * InstrumentDefinitionParser::getMangledName - for the order of determining the mangled name

Additional Comments
===================
    * The rules for getting the instrument xml for the checksum and when performing the actual load must be identical.
    * The checksum is generated by ChecksumHelper and is a SHA-1 of the file contents (after conversion to linux file endings, and trimming at both ends).
    * We can always use LoadInstrument to overwrite the IDF contained in the nexus file if we have something more up-to-date in an xml file. 
    * I think the instrument information in the MantidPlot Workspace List should indicate exactly where the IDF information came from, especially if it came from the nexus file itself.
    * We should deprecate and remove (as part of this work) any flags or fields that are not used, or at the very least, remove the code that reads them in mantid with comments explaining why this isn’t used. Deprecation is fine, although removing unused flags from IDF files cannot be done within the same release (as the IDF’s go out to users immediately), I have raised a ticket for the next release.
    * We need to capture good user documentation to explain the logic for the IDF reading. I quite often get instrument scientists asking me this.
