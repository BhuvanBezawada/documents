Documentation system
====================

Motivation
----------
Our current documentation revolves around MediaWiki.It contains all user documentation, 
e.g. algorithm descriptions, as well as all developer documentation, e.g. how to set up a
build slave. It has been commented that our documentation needs improvement and to
facilitate this we will introduce a new documentation ecosystem with better tools
to help promote writing better documentation.

This document will only address user documentation and not developer documentation. This includes:

* Algorithm pages
* Concept pages, e.g. workspace types, run object
* Python reference
* MantidPlot manual

Current state
-------------
The source of information for the documentation is currently spread out over several places, as
illustrated [here](Documentation%20workflow.png). The wikimaker, sphinx and various build jobs then
go about pulling all of the information together and pushing it into the wiki and static html areas.

Proposal overview
-----------------
It is proposed that the user documentation be brought together and written in [reStructuredText](http://docutils.sourceforge.net/rst.html).
The reST text will be placed in files within a `doc` directory within each subpackage. If any images
are required then they will be placed within an images subdirectory of the `doc` directory that requires
the image. The *.rst* files will be processed using [Sphinx](http://sphinx-doc.org/) to generate static html pages
along with auto-generating the Python API reference to another set of static pages. All of the pages will be
hosted on the managed server and all content generated by this mechanism will be removed from the wiki.

An overview of the new workflow is shown [here](Documentation%20workflow%20option%201.png).

The new workflow will leverage Sphinx's ability to use custom extensions to control how the input
*.rst* files will be processed. In Sphinx, a line of the form

    ..directivename:: options

where *directivename* is any string name, indicates to Sphinx that it should look for a directive called
*directivename* within its command list and then run any associated processing for that directive at the point
in the file. After the directive has been processed the rest of the file is then processed by the standard
Sphinx translation code.

This mechanism will be particularly useful for the algorithm documentation where there are significant sections
before the main descriptive text that will be automatically generated.

### Custom Directives
Here we outline the extra directives that will be required to generate the algorithm documentation. Assuming the 
algorithm is *Rebin*, the documentation file would look like:

    ..algorithm:: Rebin

    ..summary:: Rebin

    ..aliases:: Rebin

    ..usage:: Rebin

    ..properties:: Rebin

    [DESCRIPTIVE TEXT EXTRACTED FROM CPP FILE]

    ..categories:: Rebin

and the directives would do the following:

* `algorithm`
    - create a named reference that can be referenced with the Sphinx `:ref:` command by inserting `.. _Rebin:` at the top of the file
    - create a title for the page
    - insert a screenshot link
* `summary`:
    - insert summary text by creating an algorithm object and grabbing the text from it
* `aliases`:
    - if there are any aliases then the additional names are inserted here otherwise the section is left out
* `usage`:
    - this may not stay as a directive if we decide to stop auto-generating usages. If we keep them then it will insert a syntax-highlighted code example
* `properties`:
    - insert the table of properties for the algorithm
* `categories`:
    - records any categories that this algorithm is a part of so that category pages can be generated

### Directory Structure
The sphinx configuration and accompanying files will need to be placed in the main source tree. The top-level directory `Code/Mantid` contains a `docs` directory so it is suggested that the files are placed in subdirectories under here using the following structure:

    Code/Mantid/docs/
                  ...
                  source/
                  sphinxext/
                  ...
              
The `source` will contain, but not be limited to the following files:

    source/
      _templates/
      conf.py
      ...

where the `_templates` directory contains the Sphinx layouts for the various page types. There will also be `.rst` files for the static pages listing contents etc.

The `sphinxext` directory will contain additional plugins that are required to generate documentation as described in this document. In particular it will contain the above set of directives for the algorithm documentation. The expected directory structure will be:

    sphinxext/
      mantiddoc/
        directives/
          algorithm.py
          aliases.py
          categories.py
          properties.py
          summary.py
          usage.py
      __init__.py
        
Migration
---------
There are several steps required to move from our current state to the new setup:

1. Script to extract wiki sections and images
    * from algorithm cpp and py files to doc and images directories & reparse to rst
    * from mantidplot manual & concepts and reparse to rst
2. Create new directives as Sphinx extensions using this [sandbox](https://github.com/martyngigg/sphinxextensions) as a guide
3. Create html & css templates for the web & offline help
4. Explore `doctest` Sphinx extensions to automatically test usage examples
    * add usage test cases to algorithms
5. Clean up wiki
    * remove Algorithm, Concepts & Mantidplot Manual
    * remove Out of date pages
    * remove orphaned pages & images

Todo
----
* Add section on overall directory structure
* Add section about how to deal with screenshots
