# IN4 instrument geometry

This document describes the instrument geometry of IN4 in Mantid's instrument definition file. The file is generated by a Python script.

## Wide-angle detectors

### Detector shape

The wide-angle detector tubes are cylindrical in shape with a radius of 1.22cm (1mm thick tube wall taken into account) and a length of 30cm. The origin of the local detector coordinates is in the centre of the tube with *y'* axis parallel to the long axis of the cylinder.

### Detector boxes

The detector tubes are arranged in boxes of four, eight, or twelve detectors as shown in the figure below.

<img src="box_geometry.png" alt="Detector box geometry" />

The boxes will eventually be positioned in such a way that point *A* in the above corresponds to the sample position. Thus *r* = 2m is the sample to detector distance. The difference in &theta;' (local scattering angle) of two neighbouring detectors is 0.95&deg;. The detectors are also rotated so that their local *z'* axes intersect at *A*, i.e. the detectors are facing the sample.

### Detector banks

The instrument contains three detector banks. Each bank consists of detector boxes arranged horizontally on the surface of a sphere. One of the banks is on the same *xz* plane as the sample (the middle bank) while the two other banks are below and above it (the bottom and top banks).

While the usual cartesian coordinates are used in the instrument definition file, the coordinate system used in the generation of the banks differs somewhat from the traditional spherical coordinates. This coordinate system was chosen because it naturally described the geometry as was known at the time and it was used in the IN6 IDF generator as well.

<img src="initial_box_placement.png" alt="coordinate system and detector box placement" />

In the above figure, *&theta;* is the angle between **r** and the *z* axis (scattering angle), and *&phi;* defines the height of a detector bank from the *xz* plane.

The conversion to cartesian coordinates is given by
* *x* = *r* (cos<sup>2</sup> *&phi;* - cos<sup>2</sup> *&theta;*)<sup>1/2</sup>
* *y* = *r* sin *&phi;*
* *z* = *r* cos *&theta;*

For IN4, *r* = 2m. The *&theta;* values for box centres in degrees are given below:

| Bank         |       |      |      |      |      |      |       |      |      |       |       |
|--------------|-------|------|------|------|------|------|-------|------|------|-------|-------|
| Middle       |       |      | 18.5 | 31.5 | 44.5 | 57.5 | 69.55 | 83.5 | 96.5 | 109.5 | 118.7 |
| Top & bottom | -14.5 | 14.5 | 20.5 | 28.3 | 37.9 | 49.3 | 62.5  | 75.7 | 88.8 | 101.9 | 115.1 |

The *&phi*; angles are calculated from certain rotation angles given by the instrument's design documents, denoted here by *&alpha;*. The conversion formula is given by

*&phi;* = sin<sup>-1</sup>(sin *&alpha;* sin *&theta;*).

The *&alpha;* values are given in below in degrees:

| Bank         |        |      |      |      |      |      |      |      |      |      |      |
|--------------|--------|------|------|------|------|------|------|------|------|------|------|
| Middle       |        |      |  0.0 |  0.0 |  0.0 |  0.0 |  0.0 |  0.0 |  0.0 |  0.0 |  0.0 |
| Top & bottom | -111.0 | 58.5 | 38.2 | 29.6 | 22.0 | 17.8 | 14.7 | 13.1 | 12.4 | 12.9 | 14.3 |

The above conversion formulas above are used for the initial placement of the detector boxes in the banks.

The initial placement is followed by three rotations around the three local axes of the boxes. The first rotation is around the local *y'* axis and results in the boxes facing the global *y* axis as shown in the next figure.

<img src="first_box_rotation.png" alt="detector box geometry" />

The second rotation, this time around the local *x'* axis results in all detectors in the box facing the sample position.

<img src="second_box_rotation.png" alt="detector box geometry" />

The last rotation applied to the detector boxes will orient the local *y'* axes along the Debye-Scherrer rings. For this, two circles need to be defined: a Debye-Scherrer ring centre of which is on the *z* axis, and a detector bank ring which is centered on the *y* axis. Both circles intersect at a point defined by the detector bank centre position **r** as shown in the figure below.

<img src="rings.png" alt="Debye-Scherrer and the detector bank rings" />

After the second rotation around the local *x'* axis, the local *y'* axis of the box at **r** is on the tangent plane of the sphere defined by **r** and at 90&deg; to the tangent of the detector bank ring. We begin the last rotation by calculating a unit vector **n<sub>xz</sub>** parallel to the normal of the bank ring :
* *x* = (cos<sup>2</sup> *&phi;* - cos<sup>2</sup> *&theta;*)<sup>1/2</sup> / cos *&theta;*
* *y* = 0
* *z* = cos *&theta;* / cos *&phi;*

We also define a unit vector **t<sub>xz</sub>** which is parallel to the tangent of the bank ring. Thus, it is also on the *xz* plane, orthogonal to **n<sub>xz</sub>**, and normalized to 1. From these properties we get for **t<sub>xz</sub>**
* *x* = cos *&theta;* / cos *&phi;*
* *y* = 0
* *z* = (cos<sup>2</sup> *&phi;* - cos<sup>2</sup> *&theta;*)<sup>1/2</sup> / cos *&phi;*

The Debye-Scherrer ring is handled similarly. We construct a unit vector **n<sub>xy</sub>** parallel to the normal of the ring:
* *x* = (cos<sup>2</sup> *&phi;* - cos<sup>2</sup> *&theta;*)<sup>1/2</sup> / sin *&theta;*
* *y* = sin *&phi;* / sin *&theta;*
* *z* = 0

For the corresponding vector **t<sub>xy</sub>** parallel to the tangent of the Debye-Scherrer ring we get
* *x* = sin *&phi;* / sin *&theta;*
* *y* = (sin<sup>2</sup> *&theta;* - sin<sup>2</sup> *&phi;*)<sup>1/2</sup> / sin *&theta;*
* *z* = 0

Finally, the inner product between **t<sub>xz</sub>** and **t<sub>xy</sub>** gives

*&gamma;* = cos<sup>-1</sup> (cos *&theta;* sin *&phi;* / (sin *&theta;* cos *&phi;*)),

as the angle between the tangents of the Debye-Scherrer and detector bank rings. This is the rotation angle for the third and last rotation for the detector boxes around the local *z'* axis.

## Small-angle Rosace detector

### Pixel shape

Each pixel in the Rosace detector is constructed by combining two hexahedron shapes resulting in the shape shown in the figure below.

<img src="rosace_pixel.png" alt="The geometry of a Rosace pixel" />

The height *AB* of a pixel as well as its width *BO* depend on the scattering angle. These will be further discussed in the following section.

### Sectors

The pixels are organized into sectors, each holding 12 of them. The table below lists the scattering angles &theta; for each pixel.

|                      |       |       |       |       |       |       |       |       |       |       |       |       |
|----------------------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|
| *&theta;<sub>i</sub>* | 2.435 | 3.008 | 3.581 | 4.154 | 4.727 | 5.300 | 5.873 | 6.446 | 7.019 | 7.592 | 8.165 | 8.738 |

The geometry of a sector is based on the following assumptions on how the sector will be eventually placed:
* The centre of the sector is defined by *<&theta;>*, the average scattering angle of its pixels.
* A normal drawn from the centre point will intersect the sample position.
* The distance between the centre point and the sample *r* = 2m. 

These assumptions lead to the geometry shown in the figure below. Note that *O'* denotes the sample position in the final instrument geometry. The squares correspond to the pixel cross-sections.

<img src="rosace_sector.png" alt="The geometry of a Rosace sector" />

These considerations give the position of the *i*th detector (point *O* in the previous section) on the *y* axis

*y<sub>i</sub>* = sin *&theta;<sub>i</sub>* / cos (*<&theta;>* - *&theta;<sub>i</sub>*) * *r* / cos *<&theta;>*.

The pixel thickness *AB* is defined as min(*y<sub>i</sub>* - *y<sub>i+1</sub>*), the smallest gap between two pixels. From the knowledge of pixel thickness and *y<sub>i</sub>*, the exact positions of the pixel corners can be calculated and the pixels positioned in their respective places in a sector.

### The entire detector

To build up the Rosace itself, first the sectors are rotated around the *x* axis by *<&theta;>* as shown in the figure below.

<img src="rosace_sector_tilted.png" alt="A Rosace sector after the first rotation" />

 Then, the sectors are rotated around the *z* axis by *j* * 45&deg; to build the actual disk-like geometry. Finally, the whole detector is positioned at *z* = *r* / cos *<&theta;>* and turned to face the sample.
